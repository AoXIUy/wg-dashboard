<!DOCTYPE html>
<html lang="zh" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WireGuard Pro Dashboard</title>

    <script src="/static/js/vue.global.prod.js"></script>
    <script src="/static/js/axios.min.js"></script>
    <script src="/static/js/chart.umd.min.js"></script>
    <script src="/static/js/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="/static/js/tailwindcss.js"></script>
    <script src="/static/js/lucide.min.js"></script>
    <script src="/static/js/qrcode.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        primary: { 500: '#3b82f6', 600: '#2563eb' }
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['JetBrains Mono', 'Menlo', 'monospace'] },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'blob': 'blob 10s infinite'
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        [v-cloak] {
            display: none;
        }

        body {
            transition: background-color 0.4s ease, color 0.4s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 亮色模式 */
        body {
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
            color: #334155;
            -webkit-tap-highlight-color: transparent;
        }

        /* 暗色模式 */
        html.dark body {
            background-color: #020617;
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            color: #e2e8f0;
        }

        /* 渐变遮罩 */
        .bg-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: -1;
            transition: opacity 0.5s ease;
            background: radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(139, 92, 246, 0.08) 0%, transparent 50%);
        }

        html.dark .bg-overlay {
            background: radial-gradient(circle at 0% 0%, rgba(30, 58, 138, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(88, 28, 135, 0.15) 0%, transparent 50%);
        }

        /* 玻璃拟态卡片 */
        .glass-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        html.dark .glass-card {
            background-color: rgba(15, 23, 42, 0.65);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
        }

        .glass-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            border-color: rgba(59, 130, 246, 0.3);
        }

        html.dark .glass-card:hover {
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        /* 滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        html.dark ::-webkit-scrollbar-thumb {
            background: #334155;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        html.dark ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* 动画 */
        .list-enter-active,
        .list-leave-active {
            transition: all 0.3s ease;
        }

        .list-enter-from,
        .list-leave-to {
            opacity: 0;
            transform: translateY(10px);
        }

        .list-move {
            transition: transform 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .toast-enter-active,
        .toast-leave-active {
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .toast-enter-from,
        .toast-leave-to {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }

        .status-pulse {
            position: relative;
        }

        .status-pulse::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background-color: inherit;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            z-index: -1;
        }

        @keyframes pulse-ring {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.6;
            }

            100% {
                transform: translate(-50%, -50%) scale(2.5);
                opacity: 0;
            }
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
    </style>
</head>

<body class="min-h-screen font-sans antialiased selection:bg-blue-500 selection:text-white pb-10 overflow-x-hidden">
    <div class="bg-overlay"></div>

    <div id="app" v-cloak>
        <div
            class="fixed top-6 left-1/2 -translate-x-1/2 z-[110] flex flex-col gap-3 pointer-events-none w-full max-w-sm px-4">
            <transition-group name="toast">
                <div v-for="toast in toasts" :key="toast.id"
                    :class="['pointer-events-auto px-4 py-3 rounded-xl shadow-2xl border backdrop-blur-xl flex items-center gap-3 transform transition-all',
                     toast.type === 'error' ? 'bg-red-50/95 border-red-200 text-red-800 dark:bg-red-900/80 dark:border-red-500/30 dark:text-red-100' : 'bg-white/95 border-emerald-200 text-emerald-800 dark:bg-slate-800/90 dark:border-emerald-500/30 dark:text-emerald-100']">
                    <div
                        :class="['p-1.5 rounded-full shrink-0', toast.type === 'error' ? 'bg-red-500/20' : 'bg-emerald-500/20']">
                        <i :data-lucide="toast.type === 'error' ? 'alert-octagon' : 'check'" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium truncate">{{ toast.message }}</div>
                    </div>
                </div>
            </transition-group>
        </div>

        <div v-if="!token" class="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
            <div
                class="absolute w-[800px] h-[800px] bg-blue-500/20 dark:bg-blue-600/10 rounded-full blur-[120px] animate-blob mix-blend-multiply dark:mix-blend-screen opacity-50">
            </div>
            <div class="glass-card w-full max-w-[400px] p-8 rounded-3xl shadow-2xl relative z-10">
                <div class="text-center mb-8">
                    <div
                        class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-tr from-blue-500 to-indigo-600 mb-6 shadow-lg shadow-blue-500/30">
                        <i data-lucide="shield-check" class="w-8 h-8 text-white"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">管理员登录</h1>
                    <p class="text-slate-500 dark:text-slate-400 text-xs">WireGuard Pro Dashboard</p>
                </div>
                <form @submit.prevent="handleLogin" class="space-y-5">
                    <div class="relative group">
                        <i data-lucide="key"
                            class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                        <input v-model="loginPassword" type="password" placeholder="输入访问密钥"
                            class="w-full bg-slate-50 dark:bg-slate-900/80 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white rounded-xl pl-12 pr-4 py-3 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 outline-none transition-all placeholder:text-slate-400"
                            required>
                    </div>
                    <button type="submit" :disabled="isLoggingIn"
                        class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg shadow-blue-600/20 flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed active:scale-[0.98]">
                        <span v-if="isLoggingIn"
                            class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                        {{ isLoggingIn ? '验证中...' : '进入控制台' }}
                    </button>
                    <div v-if="loginError" class="text-red-500 text-xs text-center mt-2 animate-pulse">{{ loginError }}
                    </div>
                </form>
            </div>
        </div>

        <div v-else class="max-w-[1600px] mx-auto p-4 lg:p-8 space-y-6 relative z-10">
            <header
                class="glass-card rounded-2xl p-4 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-4 z-40 transition-all duration-300">
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <div class="relative group">
                        <div
                            class="absolute inset-0 bg-blue-500 blur-lg opacity-20 rounded-full group-hover:opacity-30 transition-opacity">
                        </div>
                        <div
                            class="bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 p-2.5 rounded-xl border border-slate-200 dark:border-white/10 relative z-10 shadow-sm">
                            <i data-lucide="activity" class="w-6 h-6 text-blue-500"></i>
                        </div>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-800 dark:text-white tracking-tight">WireGuard <span
                                class="text-blue-500">Pro</span></h1>
                        <div
                            class="flex items-center gap-2 text-[11px] text-slate-500 dark:text-slate-400 font-mono mt-0.5">
                            <span :class="['w-1.5 h-1.5 rounded-full', isConnected ? 'bg-emerald-500 status-pulse' : 'bg-red-500']"></span>
                            {{ meta.interface }}:{{ meta.port }}
                            <span v-if="!isConnected" class="text-red-500 ml-1">(连接中断)</span>
                        </div>
                    </div>
                </div>

                <div class="flex flex-wrap items-center gap-2 w-full md:w-auto justify-end">
                    <div
                        class="flex items-center gap-2 bg-slate-100/50 dark:bg-slate-900/50 p-1 rounded-xl border border-slate-200/50 dark:border-white/5 mr-2">
                        <div class="flex flex-col items-center px-3 py-1 min-w-[60px]">
                            <span class="text-[9px] text-slate-400 uppercase font-bold">CPU</span>
                            <span
                                :class="['text-xs font-mono font-bold', sysInfo.cpu_percent > 80 ? 'text-red-500' : 'text-slate-700 dark:text-slate-200']">{{
                                sysInfo.cpu_percent.toFixed(1) }}%</span>
                        </div>
                        <div class="w-[1px] h-6 bg-slate-300 dark:bg-white/10"></div>
                        <div class="flex flex-col items-center px-3 py-1 min-w-[60px]">
                            <span class="text-[9px] text-slate-400 uppercase font-bold">RAM</span>
                            <span class="text-xs font-mono font-bold text-slate-700 dark:text-slate-200">{{
                                sysInfo.mem_percent.toFixed(1) }}%</span>
                        </div>
                    </div>

                    <button @click="toggleTheme"
                        class="p-2.5 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 transition-colors">
                        <i :data-lucide="isDark ? 'sun' : 'moon'" class="w-5 h-5"></i>
                    </button>

                    <button @click="toggleAutoRefresh"
                        :class="['p-2.5 rounded-xl transition-colors', autoRefresh ? 'text-emerald-500 bg-emerald-50 dark:bg-emerald-500/10' : 'text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800']"
                        title="实时连接开关">
                        <i data-lucide="zap" :class="['w-5 h-5', autoRefresh ? 'fill-current' : '']"></i>
                    </button>

                    <button @click="openAnalysis"
                        class="p-2.5 rounded-xl hover:bg-blue-50 dark:hover:bg-blue-500/10 text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                        <i data-lucide="pie-chart" class="w-5 h-5"></i>
                    </button>

                    <button @click="logout"
                        class="p-2.5 rounded-xl hover:bg-red-50 dark:hover:bg-red-500/10 text-slate-500 dark:text-slate-400 hover:text-red-600 dark:hover:text-red-400 transition-colors">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </header>

            <section class="glass-card rounded-3xl p-6 relative overflow-hidden">
                <div
                    class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 relative z-10">
                    <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <span class="p-1.5 rounded-lg bg-blue-500/10 text-blue-600 dark:text-blue-400"><i
                                data-lucide="trending-up" class="w-4 h-4"></i></span>
                        网络流量
                    </h3>
                    <div class="flex items-center gap-4 text-xs">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                            <span class="text-slate-500 dark:text-slate-400">上传: </span>
                            <span class="font-mono font-bold text-slate-700 dark:text-white">{{ fmtRate(totalTxRate)
                                }}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                            <span class="text-slate-500 dark:text-slate-400">下载: </span>
                            <span class="font-mono font-bold text-slate-700 dark:text-white">{{ fmtRate(totalRxRate)
                                }}</span>
                        </div>
                        <select v-model="mainChartPeriod" @change="changeMainChartPeriod"
                            class="ml-2 bg-slate-100 dark:bg-slate-800 border-none rounded-lg text-slate-600 dark:text-slate-300 text-xs py-1.5 pl-3 pr-8 cursor-pointer focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="realtime">实时 (Live)</option>
                            <option value="1h">1小时</option>
                            <option value="24h">24小时</option>
                            <option value="7d">7天</option>
                        </select>
                    </div>
                </div>
                <div class="h-[280px] w-full relative z-10">
                    <canvas id="mainChart"></canvas>
                </div>
            </section>

            <section class="glass-card rounded-3xl overflow-hidden flex flex-col min-h-[600px]">
                <div
                    class="p-5 border-b border-slate-200 dark:border-white/5 flex flex-col lg:flex-row justify-between items-center gap-4 bg-slate-50/50 dark:bg-slate-900/30">
                    <div class="flex items-center gap-3 w-full lg:w-auto">
                        <h3 class="font-bold text-slate-800 dark:text-white">客户端</h3>
                        <span
                            class="px-2 py-0.5 rounded-md bg-slate-200/50 dark:bg-slate-700/50 text-xs font-medium text-slate-600 dark:text-slate-300">
                            {{ peers.length }}
                        </span>
                        <div class="h-4 w-[1px] bg-slate-300 dark:bg-slate-700 mx-1"></div>
                        <select v-model="statusFilter"
                            class="bg-transparent text-sm text-slate-600 dark:text-slate-300 outline-none cursor-pointer hover:text-blue-500 transition-colors">
                            <option value="all">全部</option>
                            <option value="online">在线 ({{ onlineCount }})</option>
                            <option value="offline">离线</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-3 w-full lg:w-auto justify-end">
                        <button @click="openAddModal"
                            class="p-2.5 rounded-xl bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-600/20 transition-all flex items-center gap-2 active:scale-95">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span class="text-sm font-bold hidden sm:inline">新增</span>
                        </button>

                        <div class="relative w-full lg:w-64 group">
                            <i data-lucide="search"
                                class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                            <input v-model="searchQuery" type="text" placeholder="搜索客户端..."
                                class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-slate-200 text-sm rounded-xl pl-9 pr-4 py-2 focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 outline-none transition-all placeholder:text-slate-400">
                        </div>
                    </div>
                </div>

                <div class="hidden md:block overflow-x-auto flex-1 custom-scrollbar">
                    <table class="w-full text-left border-collapse">
                        <thead
                            class="bg-slate-50 dark:bg-slate-900/50 text-xs text-slate-500 dark:text-slate-400 uppercase font-semibold sticky top-0 backdrop-blur-md z-20 shadow-sm">
                            <tr>
                                <th @click="sort('alias')"
                                    class="p-5 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800/50 transition-colors w-[25%]">
                                    用户 <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1 opacity-50"></i>
                                </th>
                                <th class="p-5 w-[20%]">IP / 端点</th>
                                <th @click="sort('rate')"
                                    class="p-5 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800/50 transition-colors w-[20%]">
                                    实时速率 <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1 opacity-50"></i>
                                </th>
                                <th @click="sort('transfer')"
                                    class="p-5 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800/50 transition-colors w-[20%]">
                                    流量统计 (Tx/Rx) <i data-lucide="arrow-up-down"
                                        class="w-3 h-3 inline ml-1 opacity-50"></i>
                                </th>
                                <th class="p-5 text-right w-[15%]">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 dark:divide-slate-800/50 text-sm">
                            <transition-group name="list">
                                <tr v-for="p in sortedPeers" :key="p.public_key"
                                    class="hover:bg-blue-50/50 dark:hover:bg-blue-900/10 transition-colors group">
                                    <td class="p-5">
                                        <div class="flex items-center gap-4">
                                            <div
                                                :class="['w-2.5 h-2.5 rounded-full ring-4 ring-opacity-20 transition-all', p.is_online ? 'bg-emerald-500 ring-emerald-500 status-pulse' : 'bg-slate-300 dark:bg-slate-600 ring-slate-300']">
                                            </div>
                                            <div class="min-w-0">
                                                <div v-if="editing!==p.public_key" @click="editAlias(p)"
                                                    class="font-bold text-slate-700 dark:text-slate-200 cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 flex items-center gap-2 truncate">
                                                    {{ p.alias || '未命名客户端' }}
                                                    <i data-lucide="edit-2"
                                                        class="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity text-slate-400"></i>
                                                </div>
                                                <input v-else v-model="tempAlias" @blur="saveAlias(p.public_key)"
                                                    @keyup.enter="saveAlias(p.public_key)"
                                                    class="bg-white dark:bg-slate-900 border border-blue-500 rounded px-2 py-0.5 outline-none w-32 text-xs text-slate-800 dark:text-white shadow-sm"
                                                    autofocus>
                                                <div class="text-[10px] text-slate-400 font-mono mt-1 flex items-center gap-1 group/key cursor-pointer"
                                                    @click="copyText(p.public_key, '公钥')">
                                                    {{ p.public_key.substring(0,8) }}...
                                                    <i data-lucide="copy"
                                                        class="w-2.5 h-2.5 opacity-0 group-hover/key:opacity-100 transition-opacity"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="p-5">
                                        <div class="flex flex-col gap-1">
                                            <div @click="copyText(p.allowed_ips[0], 'IP')"
                                                class="bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded border border-slate-200 dark:border-white/5 w-fit font-mono text-xs text-slate-600 dark:text-slate-300 cursor-pointer hover:border-blue-400 hover:text-blue-500 transition-all">
                                                {{ p.allowed_ips[0] }}
                                            </div>
                                            <div class="text-[10px] text-slate-400 truncate max-w-[140px]"
                                                :title="p.endpoint">{{ p.endpoint || '未连接' }}</div>
                                        </div>
                                    </td>
                                    <td class="p-5 font-mono text-xs">
                                        <div class="space-y-1">
                                            <div class="flex items-center gap-2 text-emerald-600 dark:text-emerald-400">
                                                <i data-lucide="arrow-down" class="w-3 h-3"></i> {{ fmtRate(p.rx_rate)
                                                }}
                                            </div>
                                            <div class="flex items-center gap-2 text-blue-600 dark:text-blue-400">
                                                <i data-lucide="arrow-up" class="w-3 h-3"></i> {{ fmtRate(p.tx_rate) }}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="p-5">
                                        <div class="flex flex-col gap-2 min-w-[140px]">
                                            <div class="flex justify-between text-[10px] text-slate-500">
                                                <span>Tx: {{ fmtBytes(p.transmit_bytes) }}</span>
                                                <span>Rx: {{ fmtBytes(p.receive_bytes) }}</span>
                                            </div>
                                            <div
                                                class="h-1.5 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden flex">
                                                <div class="h-full bg-blue-500"
                                                    :style="{width: getTrafficRatio(p).tx + '%'}"></div>
                                                <div class="h-full bg-emerald-500"
                                                    :style="{width: getTrafficRatio(p).rx + '%'}"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="p-5 text-right">
                                        <div class="flex justify-end gap-2">
                                            <button @click="openDetail(p)"
                                                class="p-2 rounded-lg text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-blue-600 transition-all"
                                                title="详情">
                                                <i data-lucide="bar-chart-2" class="w-4 h-4"></i>
                                            </button>
                                            <button @click="deletePeer(p)"
                                                class="p-2 rounded-lg text-slate-400 hover:bg-red-50 dark:hover:bg-red-900/20 hover:text-red-600 transition-all"
                                                title="删除">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </transition-group>
                        </tbody>
                    </table>
                    <div v-if="sortedPeers.length === 0"
                        class="flex flex-col items-center justify-center p-20 text-slate-400">
                        <i data-lucide="search-x" class="w-12 h-12 mb-4 opacity-50"></i>
                        <p>未找到匹配的客户端</p>
                    </div>
                </div>

                <div class="md:hidden p-4 space-y-4 flex-1 overflow-y-auto">
                    <transition-group name="list">
                        <div v-for="p in sortedPeers" :key="p.public_key"
                            class="bg-white dark:bg-slate-800/40 rounded-2xl p-4 border border-slate-100 dark:border-white/5 shadow-sm active:scale-[0.99] transition-transform">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center gap-3">
                                    <div
                                        :class="['w-2 h-2 rounded-full', p.is_online ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]' : 'bg-slate-300 dark:bg-slate-600']">
                                    </div>
                                    <div class="flex flex-col">
                                        <div class="font-bold text-sm text-slate-800 dark:text-white flex items-center gap-2"
                                            @click="editAlias(p)">
                                            {{ p.alias || '未命名' }}
                                        </div>
                                        <div class="text-[10px] text-slate-500 font-mono">{{ p.allowed_ips[0] }}</div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="deletePeer(p)"
                                        class="p-2 -mr-2 -mt-2 text-slate-400 hover:text-red-500">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                    <button @click="openDetail(p)"
                                        class="p-2 -mr-2 -mt-2 text-slate-400 hover:text-blue-500">
                                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div
                                class="grid grid-cols-2 gap-2 bg-slate-50 dark:bg-slate-900/50 rounded-xl p-3 border border-slate-100 dark:border-white/5">
                                <div>
                                    <div class="text-[10px] text-slate-400 mb-0.5">下载速率</div>
                                    <div class="text-emerald-600 dark:text-emerald-400 font-mono text-sm font-bold">{{
                                        fmtRate(p.rx_rate) }}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[10px] text-slate-400 mb-0.5">上传速率</div>
                                    <div class="text-blue-600 dark:text-blue-400 font-mono text-sm font-bold">{{
                                        fmtRate(p.tx_rate) }}</div>
                                </div>
                            </div>
                        </div>
                    </transition-group>
                </div>
            </section>
        </div>

        <Transition enter-active-class="transition duration-300 ease-out" enter-from-class="opacity-0 scale-95 blur-sm"
            enter-to-class="opacity-100 scale-100 blur-0" leave-active-class="transition duration-200 ease-in"
            leave-from-class="opacity-100 scale-100" leave-to-class="opacity-0 scale-95 blur-sm">
            <div v-if="showAddModal"
                class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="glass-card bg-white dark:bg-[#0f172a] rounded-3xl w-full max-w-md p-6 shadow-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <i data-lucide="user-plus" class="w-5 h-5 text-blue-500"></i> 新增客户端
                        </h2>
                        <button @click="showAddModal=false"
                            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full text-slate-500"><i
                                data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <form @submit.prevent="createPeer" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">接口
                                (Interface)</label>
                            <select v-model="newPeer.config" @change="suggestIP"
                                class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500/50 outline-none">
                                <option v-for="c in availableConfigs" :value="c">{{ c }}</option>
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">备注名称</label>
                            <input v-model="newPeer.name" type="text" placeholder="例如: iPhone-User"
                                class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500/50 outline-none"
                                required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">分配 IP
                                (AllowedIPs)</label>
                            <div class="flex gap-2">
                                <input v-model="newPeer.ip" type="text" placeholder="自动分配..."
                                    class="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500/50 outline-none"
                                    required>
                                <button type="button" @click="suggestIP"
                                    class="px-3 py-2 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-xl text-sm hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors flex items-center gap-1">
                                    <i v-if="ipLoading" data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                                    <span v-else>自动</span>
                                </button>
                            </div>
                        </div>
                        <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg shadow-blue-600/20 mt-2">
                            创建并应用
                        </button>
                    </form>
                </div>
            </div>
        </Transition>

        <Transition enter-active-class="transition duration-300 ease-out" enter-from-class="opacity-0 scale-95 blur-sm"
            enter-to-class="opacity-100 scale-100 blur-0" leave-active-class="transition duration-200 ease-in"
            leave-from-class="opacity-100 scale-100" leave-to-class="opacity-0 scale-95 blur-sm">
            <div v-if="showConfigModal"
                class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4"
                @click.self="showConfigModal=false">
                <div
                    class="glass-card bg-white dark:bg-[#0f172a] rounded-3xl w-full max-w-md p-6 shadow-2xl flex flex-col items-center">
                    <div class="flex justify-between items-center w-full mb-4">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <i data-lucide="qr-code" class="w-5 h-5 text-emerald-500"></i> 配置创建成功
                        </h2>
                        <button @click="showConfigModal=false"
                            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full text-slate-500"><i
                                data-lucide="x" class="w-5 h-5"></i></button>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-inner mb-4 relative group">
                        <div id="qrcode"></div>
                        <div class="absolute inset-0 flex items-center justify-center bg-white/90 text-slate-500 text-xs opacity-0 transition-opacity pointer-events-none"
                            :class="{'opacity-100': isQrUpdating}">
                            <i data-lucide="refresh-cw" class="w-4 h-4 animate-spin mr-1"></i> 更新中...
                        </div>
                    </div>

                    <div class="w-full mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <div
                                class="text-xs text-yellow-600 bg-yellow-50 dark:bg-yellow-900/20 dark:text-yellow-400 px-2 py-1 rounded flex items-center gap-1">
                                <i data-lucide="alert-triangle" class="w-3 h-3"></i> 私钥仅显示一次
                            </div>
                            <span class="text-[10px] text-slate-400">可编辑下方文本实时更新二维码</span>
                        </div>
                        <textarea v-model="generatedConfigStr"
                            class="w-full h-32 bg-slate-50 dark:bg-slate-900 font-mono text-xs p-3 rounded-xl border border-slate-200 dark:border-slate-700 outline-none resize-none focus:ring-2 focus:ring-emerald-500/50 transition-all"
                            placeholder="在此编辑配置...">
                        </textarea>
                    </div>

                    <button @click="downloadConfig"
                        class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-emerald-600/20 flex items-center justify-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> 下载 .conf 文件
                    </button>
                </div>
            </div>
        </Transition>

        <Transition enter-active-class="transition duration-300 ease-out" enter-from-class="opacity-0 scale-95 blur-sm"
            enter-to-class="opacity-100 scale-100 blur-0" leave-active-class="transition duration-200 ease-in"
            leave-from-class="opacity-100 scale-100" leave-to-class="opacity-0 scale-95 blur-sm">
            <div v-if="showAnalysis"
                class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4"
                @click.self="showAnalysis=false">
                <div
                    class="glass-card bg-white dark:bg-[#0f172a] rounded-3xl w-full max-w-5xl flex flex-col max-h-[85vh] shadow-2xl overflow-hidden">
                    <div
                        class="flex justify-between items-center p-5 border-b border-slate-100 dark:border-white/5 bg-slate-50/50 dark:bg-slate-900/50">
                        <h2 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <i data-lucide="pie-chart" class="w-5 h-5 text-blue-500"></i> 网络分析
                        </h2>
                        <button @click="showAnalysis=false"
                            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full text-slate-500"><i
                                data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                        <div v-if="analysisLoading" class="flex flex-col items-center justify-center h-[400px] gap-3">
                            <div
                                class="animate-spin w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full">
                            </div>
                            <span class="text-slate-400 text-sm">正在分析网络数据...</span>
                        </div>
                        <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div
                                class="bg-slate-50 dark:bg-slate-800/30 p-5 rounded-2xl border border-slate-100 dark:border-white/5 flex flex-col">
                                <h3
                                    class="text-sm font-bold text-slate-600 dark:text-slate-300 mb-4 flex items-center gap-2">
                                    <i data-lucide="disc" class="w-4 h-4"></i> 流量占比 (Top 5)
                                </h3>
                                <div class="h-[250px] w-full relative">
                                    <canvas id="trafficPieChart"></canvas>
                                </div>
                            </div>
                            <div
                                class="bg-slate-50 dark:bg-slate-800/30 p-5 rounded-2xl border border-slate-100 dark:border-white/5 flex flex-col">
                                <h3
                                    class="text-sm font-bold text-slate-600 dark:text-slate-300 mb-4 flex items-center gap-2">
                                    <i data-lucide="bar-chart" class="w-4 h-4"></i> 24小时活跃度
                                </h3>
                                <div class="h-[250px] w-full relative">
                                    <canvas id="activityBarChart"></canvas>
                                </div>
                            </div>
                            <div
                                class="md:col-span-2 bg-slate-50 dark:bg-slate-800/30 rounded-2xl border border-slate-100 dark:border-white/5 overflow-hidden">
                                <div
                                    class="p-4 border-b border-slate-200 dark:border-white/5 bg-slate-100/50 dark:bg-slate-900/30">
                                    <h3
                                        class="font-bold text-slate-800 dark:text-white text-sm flex items-center gap-2">
                                        <i data-lucide="activity" class="w-4 h-4 text-blue-500"></i> 客户端健康评分
                                    </h3>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left text-sm">
                                        <thead
                                            class="bg-slate-100 dark:bg-slate-900/50 text-xs text-slate-500 dark:text-slate-400">
                                            <tr>
                                                <th class="p-4">用户</th>
                                                <th class="p-4">总流量</th>
                                                <th class="p-4">在线率 (7d)</th>
                                                <th class="p-4">健康分</th>
                                                <th class="p-4 text-right">最后活跃</th>
                                            </tr>
                                        </thead>
                                        <tbody
                                            class="divide-y divide-slate-200 dark:divide-white/5 text-slate-700 dark:text-slate-300">
                                            <tr v-for="p in analysisData.peers" :key="p.public_key"
                                                class="hover:bg-slate-100/80 dark:hover:bg-white/5 transition-colors">
                                                <td class="p-4 font-medium">
                                                    <div class="flex items-center gap-2">
                                                        <div class="w-2 h-2 rounded-full"
                                                            :class="p.health_score > 80 ? 'bg-emerald-500' : (p.health_score > 50 ? 'bg-yellow-500' : 'bg-red-500')">
                                                        </div>
                                                        {{ p.alias || p.public_key.substring(0,8) }}
                                                    </div>
                                                </td>
                                                <td class="p-4 font-mono text-xs">{{ fmtBytes(p.total_rx+p.total_tx) }}
                                                </td>
                                                <td class="p-4">
                                                    <div class="flex items-center gap-2">
                                                        <div
                                                            class="w-24 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                                                            <div class="h-full bg-blue-500"
                                                                :style="{width: p.uptime_percent+'%'}"></div>
                                                        </div>
                                                        <span class="text-xs text-slate-500">{{
                                                            p.uptime_percent.toFixed(0) }}%</span>
                                                    </div>
                                                </td>
                                                <td class="p-4">
                                                    <span class="px-2 py-0.5 rounded text-xs font-bold border"
                                                        :class="getHealthClass(p.health_score)">{{ p.health_score
                                                        }}</span>
                                                </td>
                                                <td class="p-4 text-right text-xs text-slate-500 font-mono">{{
                                                    formatLastSeen(p.last_seen_time) }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </Transition>

        <Transition enter-active-class="transition duration-300 ease-out" enter-from-class="opacity-0 translate-y-8"
            enter-to-class="opacity-100 translate-y-0" leave-active-class="transition duration-200 ease-in"
            leave-from-class="opacity-100" leave-to-class="opacity-0 translate-y-8">
            <div v-if="modalPeer"
                class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4"
                @click.self="modalPeer=null">
                <div class="glass-card bg-white dark:bg-[#0f172a] rounded-3xl w-full max-w-4xl p-6 shadow-2xl">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white text-xl font-bold shadow-lg shadow-blue-500/30">
                                {{ (modalPeer.alias || 'U').charAt(0).toUpperCase() }}
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-slate-800 dark:text-white">{{ modalPeer.alias ||
                                    '详细信息' }}</h2>
                                <p class="text-xs text-slate-500 font-mono mt-1">{{ modalPeer.public_key }}</p>
                            </div>
                        </div>
                        <button @click="modalPeer=null"
                            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg text-slate-500"><i
                                data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <div class="flex justify-end mb-4">
                        <div class="bg-slate-100 dark:bg-slate-800 rounded-lg p-1 flex text-xs">
                            <button v-for="p in ['realtime','1h','24h','7d']" :key="p"
                                @click="historyPeriod=p; changeHistoryPeriod()"
                                :class="['px-3 py-1.5 rounded-md transition-all', historyPeriod===p ? 'bg-white dark:bg-slate-600 shadow text-blue-600 dark:text-white font-bold' : 'text-slate-500 hover:text-slate-800 dark:hover:text-slate-300']">
                                {{ p.toUpperCase() }}
                            </button>
                        </div>
                    </div>

                    <div
                        class="h-[350px] w-full bg-slate-50 dark:bg-slate-900/30 rounded-2xl p-4 border border-slate-100 dark:border-white/5 relative mb-4">
                        <div v-if="chartLoading"
                            class="absolute inset-0 flex items-center justify-center bg-white/50 dark:bg-slate-900/50 backdrop-blur-[1px] z-10 rounded-2xl">
                            <div
                                class="animate-spin w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full">
                            </div>
                        </div>
                        <canvas id="detailChart"></canvas>
                    </div>

                    <div
                        class="bg-slate-50 dark:bg-slate-900/30 rounded-2xl border border-slate-100 dark:border-white/5 overflow-hidden flex flex-col max-h-[300px]">
                        <div
                            class="p-3 border-b border-slate-200 dark:border-white/5 bg-slate-100/50 dark:bg-slate-900/50 flex items-center justify-between sticky top-0">
                            <h3 class="font-bold text-slate-700 dark:text-slate-300 text-sm flex items-center gap-2">
                                <i data-lucide="history" class="w-4 h-4 text-blue-500"></i> 连接历史
                            </h3>
                            <button @click="fetchAccessLogs"
                                class="p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded text-slate-400">
                                <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                            </button>
                        </div>
                        <div class="overflow-y-auto custom-scrollbar">
                            <table class="w-full text-left text-xs">
                                <thead
                                    class="bg-slate-100 dark:bg-slate-900/80 text-slate-500 dark:text-slate-400 sticky top-0 z-10">
                                    <tr>
                                        <th class="p-3">时间</th>
                                        <th class="p-3">来源 IP</th>
                                        <th class="p-3 text-right">累计下载 (Rx)</th>
                                        <th class="p-3 text-right">累计上传 (Tx)</th>
                                    </tr>
                                </thead>
                                <tbody
                                    class="divide-y divide-slate-200 dark:divide-white/5 text-slate-600 dark:text-slate-300 font-mono">
                                    <tr v-if="logsLoading">
                                        <td colspan="4" class="p-4 text-center text-slate-400">加载中...</td>
                                    </tr>
                                    <tr v-else-if="accessLogs.length === 0">
                                        <td colspan="4" class="p-4 text-center text-slate-400">暂无历史记录</td>
                                    </tr>
                                    <tr v-for="log in accessLogs" :key="log.timestamp + log.endpoint"
                                        class="hover:bg-slate-100 dark:hover:bg-white/5 transition-colors">
                                        <td class="p-3 text-slate-500">{{ log.timestamp }}</td>
                                        <td class="p-3">
                                            <div class="flex items-center gap-2">
                                                <img v-if="getCountryCode(log.endpoint)"
                                                    :src="`https://flagcdn.com/w20/${getCountryCode(log.endpoint).toLowerCase()}.png`"
                                                    class="w-5 h-auto rounded shadow-sm object-cover"
                                                    :title="getCountryCode(log.endpoint)">
                                                <span class="font-bold font-mono">{{ log.endpoint }}</span>
                                            </div>
                                        </td>
                                        <td class="p-3 text-right text-emerald-600 dark:text-emerald-400">{{
                                            fmtBytes(log.rx_total) }}</td>
                                        <td class="p-3 text-right text-blue-600 dark:text-blue-400">{{
                                            fmtBytes(log.tx_total) }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </Transition>

        <Transition enter-active-class="transition duration-300 ease-out" enter-from-class="opacity-0 scale-95 blur-sm"
            enter-to-class="opacity-100 scale-100 blur-0" leave-active-class="transition duration-200 ease-in"
            leave-from-class="opacity-100 scale-100" leave-to-class="opacity-0 scale-95 blur-sm">
            <div v-if="showDeleteModal"
                class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div
                    class="glass-card bg-white dark:bg-[#0f172a] rounded-3xl w-full max-w-sm p-6 shadow-2xl text-center">

                    <div
                        class="mx-auto flex h-14 w-14 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/30 mb-4">
                        <i data-lucide="alert-triangle" class="h-8 w-8 text-red-600 dark:text-red-500"></i>
                    </div>

                    <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-2">确认删除客户端?</h3>

                    <div class="text-sm text-slate-500 dark:text-slate-400 mb-6">
                        您确定要删除 <span class="font-bold text-slate-800 dark:text-slate-200 mx-1">{{ peerToDelete?.alias ||
                            '未命名' }}</span> 吗？
                        <br>
                        <span class="text-xs mt-1 block text-red-500/80">此操作将修改配置文件并立即重启接口。</span>
                    </div>

                    <div class="flex gap-3">
                        <button @click="showDeleteModal=false" type="button"
                            class="flex-1 px-4 py-2.5 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-xl font-medium hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                            取消
                        </button>
                        <button @click="confirmDelete" :disabled="deleteLoading" type="button"
                            class="flex-1 px-4 py-2.5 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700 shadow-lg shadow-red-600/20 transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed">
                            <i v-if="deleteLoading" data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                            <span v-else>确认删除</span>
                        </button>
                    </div>
                </div>
            </div>
        </Transition>
        </div>

    <script>
        const { createApp, ref, reactive, onMounted, onUnmounted, computed, nextTick, watch } = Vue;

        // --- Chart.js 全局配置 ---
        Chart.defaults.font.family = "'JetBrains Mono', 'Inter', system-ui, sans-serif";
        Chart.defaults.color = '#64748b';
        Chart.defaults.scale.grid.color = 'transparent';
        Chart.defaults.maintainAspectRatio = false;
        Chart.defaults.responsive = true;
        Chart.defaults.animation = false;
        Chart.defaults.elements.line.borderWidth = 1.5;
        Chart.defaults.elements.line.tension = 0.4;
        Chart.defaults.elements.point.radius = 0;
        Chart.defaults.elements.point.hitRadius = 20;
        Chart.defaults.elements.point.hoverRadius = 4;
        Chart.defaults.plugins.tooltip.enabled = true;
        Chart.defaults.plugins.tooltip.mode = 'index';
        Chart.defaults.plugins.tooltip.intersect = false;
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15, 23, 42, 0.9)';
        Chart.defaults.plugins.tooltip.titleColor = '#fff';
        Chart.defaults.plugins.tooltip.bodyColor = '#cbd5e1';
        Chart.defaults.plugins.tooltip.borderColor = 'rgba(255,255,255,0.1)';
        Chart.defaults.plugins.tooltip.borderWidth = 1;
        Chart.defaults.plugins.tooltip.padding = 10;
        Chart.defaults.plugins.tooltip.cornerRadius = 8;
        Chart.defaults.plugins.tooltip.displayColors = true;
        Chart.defaults.plugins.tooltip.boxPadding = 4;

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        createApp({
            setup() {
                const token = ref(localStorage.getItem('wg_token') || '');
                const peers = ref([]);
                const sysInfo = ref({ cpu_percent: 0, mem_percent: 0 });
                const meta = ref({ interface: 'wg0', port: '51820' });

                const searchQuery = ref('');
                const debouncedSearch = ref('');
                const statusFilter = ref('all');
                const loginPassword = ref('');
                const loginError = ref('');
                const isLoggingIn = ref(false);
                const autoRefresh = ref(true);
                const toasts = ref([]);
                const isDark = ref(false);
                const isConnected = ref(false);

                const sortKey = ref('rate');
                const sortDesc = ref(true);
                const mainChartPeriod = ref('realtime');
                const modalPeer = ref(null);
                const historyPeriod = ref('realtime');
                const chartLoading = ref(false);

                const showAnalysis = ref(false);
                const analysisLoading = ref(false);
                const analysisData = ref(null);

                // 管理功能状态
                const showAddModal = ref(false);
                const showConfigModal = ref(false);
                const availableConfigs = ref([]);
                const newPeer = reactive({ config: '', name: '', ip: '' });
                const generatedConfigStr = ref('');
                const ipLoading = ref(false);
                const isQrUpdating = ref(false);

                // 删除确认弹窗状态
                const showDeleteModal = ref(false);
                const peerToDelete = ref(null);
                const deleteLoading = ref(false);

                // 历史日志状态
                const accessLogs = ref([]);
                const logsLoading = ref(false);

                // SSE EventSource
                const es = ref(null);

                // --- IP 地理位置缓存 ---
                const ipCache = reactive({});
                const getIp = (endpoint) => endpoint ? endpoint.split(':')[0].replace('[', '').replace(']', '') : '';
                const isPrivateIp = (ip) => ip.startsWith('127.') || ip.startsWith('10.') || ip.startsWith('192.168.') || ip.startsWith('172.16.');

                const resolveIpLocation = async (endpoint) => {
                    const ip = getIp(endpoint);
                    if (!ip || isPrivateIp(ip) || ipCache.hasOwnProperty(ip)) return;
                    ipCache[ip] = '';
                    try {
                        const res = await fetch(`http://ip-api.com/json/${ip}?fields=status,countryCode`);
                        const data = await res.json();
                        if (data.status === 'success') ipCache[ip] = data.countryCode;
                    } catch (e) { }
                };

                const getCountryCode = (endpoint) => ipCache[getIp(endpoint)];

                let mainChartInst = null;
                let detailChartInst = null;
                let pieChart = null;
                let barChart = null;
                let iconsTimer = null;

                const createGradient = (ctx, c1, c2) => {
                    const gradient = ctx.createLinearGradient(0, 0, 0, 320);
                    gradient.addColorStop(0, c1);
                    gradient.addColorStop(0.9, c2);
                    return gradient;
                };

                const initTheme = () => {
                    const saved = localStorage.getItem('theme');
                    if (saved) isDark.value = saved === 'dark';
                    else isDark.value = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                    applyTheme();
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                        if (!localStorage.getItem('theme')) {
                            isDark.value = e.matches;
                            applyTheme();
                        }
                    });
                };

                const toggleTheme = () => {
                    isDark.value = !isDark.value;
                    localStorage.setItem('theme', isDark.value ? 'dark' : 'light');
                    applyTheme();
                };

                const applyTheme = () => {
                    if (isDark.value) document.documentElement.classList.add('dark');
                    else document.documentElement.classList.remove('dark');
                    updateChartTheme();
                };

                const updateChartTheme = () => {
                    const textColor = isDark.value ? '#94a3b8' : '#64748b';
                    const gridColor = isDark.value ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.03)';
                    [mainChartInst, detailChartInst, pieChart, barChart].forEach(chart => {
                        if (chart) {
                            if (chart.options.scales.x) chart.options.scales.x.ticks.color = textColor;
                            if (chart.options.scales.y) {
                                chart.options.scales.y.ticks.color = textColor;
                                chart.options.scales.y.grid.color = gridColor;
                            }
                            chart.options.plugins.tooltip.titleColor = '#fff';
                            chart.update('none');
                        }
                    });
                };

                const handleLogin = async () => {
                    if (!loginPassword.value) return;
                    isLoggingIn.value = true;
                    await new Promise(r => setTimeout(r, 600));
                    try {
                        const res = await axios.post('/api/login', { password: loginPassword.value });
                        token.value = res.data.token;
                        localStorage.setItem('wg_token', token.value);
                        showToast('登录成功');
                        initDashboard();
                    } catch (e) {
                        loginError.value = e.response?.data?.error || '密钥无效';
                        setTimeout(() => loginError.value = '', 3000);
                    } finally {
                        isLoggingIn.value = false;
                    }
                };

                const logout = () => {
                    if (es.value) es.value.close();
                    token.value = '';
                    localStorage.removeItem('wg_token');
                    isConnected.value = false;
                    mainChartInst?.destroy(); mainChartInst = null;
                };

                // --- SSE 核心逻辑 ---
                const initSSE = () => {
                    if (es.value) es.value.close();
                    if (!token.value) return;

                    // 使用 token 参数连接 SSE
                    es.value = new EventSource(`/api/stream?token=${encodeURIComponent(token.value)}`);

                    es.value.onopen = () => {
                        console.log("SSE Connected");
                        isConnected.value = true;
                        loginError.value = '';
                    };

                    es.value.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            // 更新核心数据
                            peers.value = data.peers || [];
                            sysInfo.value = data.system || { cpu_percent: 0, mem_percent: 0 };
                            
                            // 实时更新图表
                            updateRealtimeChart(data.peers);

                            // 刷新图标
                            refreshIcons();
                        } catch (e) {
                            console.error('SSE Parse Error', e);
                        }
                    };

                    es.value.onerror = (err) => {
                        console.error("SSE Error", err);
                        isConnected.value = false;
                        es.value.close();
                        // 3秒重连
                        if (autoRefresh.value) {
                            setTimeout(() => {
                                if (token.value) initSSE();
                            }, 3000);
                        }
                    };
                };

                const toggleAutoRefresh = () => {
                    autoRefresh.value = !autoRefresh.value;
                    if (autoRefresh.value) {
                        if (!isConnected.value) initSSE();
                        showToast('实时连接已开启');
                    } else {
                        if (es.value) es.value.close();
                        isConnected.value = false;
                        showToast('实时连接已暂停', 'error');
                    }
                };

                // 实时更新图表（追加数据点，不重绘整个图表）
                const updateRealtimeChart = (currentPeers) => {
                    if (mainChartPeriod.value !== 'realtime' || !mainChartInst) return;

                    const tx = currentPeers.reduce((a, b) => a + (b.tx_rate || 0), 0);
                    const rx = currentPeers.reduce((a, b) => a + (b.rx_rate || 0), 0);
                    const now = Date.now();

                    // 追加新数据点
                    mainChartInst.data.labels.push(now);
                    mainChartInst.data.datasets[0].data.push(tx);
                    mainChartInst.data.datasets[1].data.push(rx);

                    // 保持窗口大小（约10分钟数据，2秒一个点 = 300点）
                    const maxPoints = 300;
                    if (mainChartInst.data.labels.length > maxPoints) {
                        mainChartInst.data.labels.shift();
                        mainChartInst.data.datasets[0].data.shift();
                        mainChartInst.data.datasets[1].data.shift();
                    }

                    mainChartInst.update('none'); // 高性能更新模式
                };

                const initDashboard = () => {
                    // 1. 获取元数据
                    axios.get('/api/peers', { headers: { Authorization: `Bearer ${token.value}` } })
                        .then(res => {
                            meta.value = res.data;
                            peers.value = res.data.peers || []; // 初始渲染一次
                        })
                        .catch(e => {
                            if (e.response?.status === 401) logout();
                        });
                    
                    // 2. 初始化图表历史数据
                    fetchMainChart();

                    // 3. 启动 SSE
                    initSSE();
                };

                watch(searchQuery, debounce((val) => { debouncedSearch.value = val; }, 300));

                const sortCache = ref(new Map());
                const lastSortTime = ref(0);
                const sortedPeers = computed(() => {
                    let list = peers.value.filter(p => {
                        if (debouncedSearch.value) {
                            const q = debouncedSearch.value.toLowerCase();
                            return (p.alias || '').toLowerCase().includes(q) ||
                                p.allowed_ips.some(ip => ip.includes(q)) ||
                                p.public_key.toLowerCase().includes(q);
                        }
                        return (statusFilter.value === 'all') ||
                            (statusFilter.value === 'online' && p.is_online) ||
                            (statusFilter.value === 'offline' && !p.is_online);
                    });

                    const now = Date.now();
                    const shouldRecalculate = now - lastSortTime.value > 5000;

                    return list.sort((a, b) => {
                        let valA, valB;
                        if (sortKey.value === 'rate') {
                            const kA = a.public_key, kB = b.public_key;
                            const curA = (a.rx_rate || 0) + (a.tx_rate || 0), curB = (b.rx_rate || 0) + (b.tx_rate || 0);

                            if (shouldRecalculate || !sortCache.value.has(kA) || Math.abs(curA - sortCache.value.get(kA)) > 1) sortCache.value.set(kA, curA);
                            if (shouldRecalculate || !sortCache.value.has(kB) || Math.abs(curB - sortCache.value.get(kB)) > 1) sortCache.value.set(kB, curB);

                            valA = sortCache.value.get(kA); valB = sortCache.value.get(kB);
                            if (shouldRecalculate) lastSortTime.value = now;
                            if (Math.abs(valA - valB) < 0.5) return 0;
                        } else if (sortKey.value === 'transfer') {
                            valA = (a.receive_bytes || 0) + (a.transmit_bytes || 0);
                            valB = (b.receive_bytes || 0) + (b.transmit_bytes || 0);
                        } else {
                            valA = a.alias || ''; valB = b.alias || '';
                        }
                        return sortDesc.value ? (valA < valB ? 1 : -1) : (valA > valB ? 1 : -1);
                    });
                });

                const fetchMainChart = async () => {
                    if (!token.value) return;
                    try {
                        const res = await axios.get(`/api/chart/traffic?period=${mainChartPeriod.value}`, { headers: { Authorization: `Bearer ${token.value}` } });
                        renderMainChart(res.data);
                    } catch (e) { }
                };

                const renderMainChart = (data) => {
                    const ctxEl = document.getElementById('mainChart');
                    if (!ctxEl) return;

                    let unit = 'minute';
                    let displayFormat = 'HH:mm';

                    if (mainChartPeriod.value === '24h') {
                        unit = 'hour';
                    } else if (mainChartPeriod.value === '7d') {
                        unit = 'day';
                        displayFormat = 'MM-dd';
                    }

                    const labels = data.labels.map(t => t * 1000);
                    const maxVal = Math.max(...data.tx, ...data.rx);
                    const suggestedMax = Math.max(maxVal * 1.1, 10);

                    if (mainChartInst) {
                        // 如果是切换周期，重置数据
                        mainChartInst.data.labels = labels;
                        mainChartInst.data.datasets[0].data = data.tx;
                        mainChartInst.data.datasets[1].data = data.rx;
                        mainChartInst.options.scales.x.time.unit = unit;
                        mainChartInst.options.scales.x.time.displayFormats[unit] = displayFormat;
                        mainChartInst.options.scales.y.suggestedMax = suggestedMax;
                        mainChartInst.update();
                    } else {
                        const ctx = ctxEl.getContext('2d');
                        mainChartInst = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: '上传', data: data.tx, borderColor: '#3b82f6',
                                        backgroundColor: createGradient(ctx, 'rgba(59, 130, 246, 0.15)', 'rgba(59, 130, 246, 0.0)'),
                                        fill: true, normalized: true, tension: 0.4
                                    },
                                    {
                                        label: '下载', data: data.rx, borderColor: '#10b981',
                                        backgroundColor: createGradient(ctx, 'rgba(16, 185, 129, 0.15)', 'rgba(16, 185, 129, 0.0)'),
                                        fill: true, normalized: true, tension: 0.4
                                    }
                                ]
                            },
                            options: {
                                animation: false, // 禁用初始动画，由SSE驱动
                                scales: {
                                    x: {
                                        type: 'time',
                                        time: { unit: unit, displayFormats: { [unit]: displayFormat } },
                                        grid: { display: false },
                                        ticks: { maxTicksLimit: 8, autoSkip: true, maxRotation: 0, color: isDark.value ? '#94a3b8' : '#64748b' }
                                    },
                                    y: { border: { display: false }, grid: { display: true, color: isDark.value ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.03)' }, ticks: { callback: v => v + ' M', maxTicksLimit: 5, padding: 8, color: isDark.value ? '#94a3b8' : '#64748b' }, beginAtZero: true, suggestedMax: suggestedMax }
                                },
                                plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => ` ${c.dataset.label}: ${c.parsed.y.toFixed(2)} Mbps` } } }
                            }
                        });
                    }
                };

                const openDetail = (p) => {
                    modalPeer.value = p;
                    fetchDetailData();
                    fetchAccessLogs();
                };

                const fetchDetailData = async () => {
                    if (!modalPeer.value) return;
                    chartLoading.value = true;
                    try {
                        const res = await axios.get(`/api/history/${modalPeer.value.public_key}?period=${historyPeriod.value}`, { headers: { Authorization: `Bearer ${token.value}` } });
                        nextTick(() => renderDetailChart(res.data));
                    } catch { showToast('无法加载历史数据', 'error'); }
                    finally { chartLoading.value = false; }
                };

                const fetchAccessLogs = async () => {
                    if (!modalPeer.value) return;
                    logsLoading.value = true;
                    accessLogs.value = [];
                    try {
                        const res = await axios.get(`/api/history/logs/${modalPeer.value.public_key}`, {
                            headers: { Authorization: `Bearer ${token.value}` }
                        });
                        accessLogs.value = res.data.logs || [];
                        accessLogs.value.forEach(log => {
                            resolveIpLocation(log.endpoint);
                        });
                    } catch (e) {
                    } finally {
                        logsLoading.value = false;
                        nextTick(() => lucide.createIcons());
                    }
                };

                const renderDetailChart = (data) => {
                    const ctxEl = document.getElementById('detailChart');
                    if (!ctxEl) return;
                    const ctx = ctxEl.getContext('2d');
                    if (detailChartInst) detailChartInst.destroy();

                    detailChartInst = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.labels.map(t => t * 1000),
                            datasets: [{
                                label: '下载', data: data.rates.rx, borderColor: '#10b981',
                                backgroundColor: createGradient(ctx, 'rgba(16, 185, 129, 0.1)', 'rgba(16, 185, 129, 0)'),
                                fill: true, pointBackgroundColor: '#10b981'
                            }, {
                                label: '上传', data: data.rates.tx, borderColor: '#3b82f6',
                                backgroundColor: createGradient(ctx, 'rgba(59, 130, 246, 0.1)', 'rgba(59, 130, 246, 0)'),
                                fill: true, pointBackgroundColor: '#3b82f6'
                            }]
                        },
                        options: {
                            animation: { duration: 800, easing: 'easeOutQuart' },
                            plugins: {
                                legend: { display: true, align: 'end', labels: { usePointStyle: true, boxWidth: 6, color: isDark.value ? '#cbd5e1' : '#475569' } },
                                tooltip: { callbacks: { label: (c) => ` ${c.dataset.label}: ${c.parsed.y.toFixed(2)} Mbps` } }
                            },
                            scales: {
                                x: { type: 'time', grid: { display: false }, ticks: { color: isDark.value ? '#94a3b8' : '#64748b', maxTicksLimit: 6 } },
                                y: { border: { display: false }, grid: { color: isDark.value ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.03)' }, ticks: { color: isDark.value ? '#94a3b8' : '#64748b', callback: v => v + ' Mbps' }, beginAtZero: true, suggestedMax: 10 }
                            }
                        }
                    });
                };

                const openAnalysis = async () => {
                    showAnalysis.value = true;
                    analysisLoading.value = true;
                    analysisData.value = null;
                    try {
                        const res = await axios.get('/api/analysis', { headers: { Authorization: `Bearer ${token.value}` } });
                        analysisData.value = res.data;
                    } catch (e) { showToast('分析加载失败', 'error'); }
                    finally {
                        analysisLoading.value = false;
                        await nextTick();
                        renderAnalysisCharts();
                        lucide.createIcons();
                    }
                };

                const renderAnalysisCharts = () => {
                    if (!analysisData.value) return;
                    const pieEl = document.getElementById('trafficPieChart');
                    const barEl = document.getElementById('activityBarChart');
                    if (pieChart) { pieChart.destroy(); pieChart = null; }
                    if (barChart) { barChart.destroy(); barChart = null; }

                    const textColor = isDark.value ? '#94a3b8' : '#64748b';

                    if (pieEl && analysisData.value.peers) {
                        const top = analysisData.value.peers.slice(0, 5);
                        const otherTotal = analysisData.value.peers.slice(5).reduce((acc, curr) => acc + (curr.total_rx + curr.total_tx), 0);
                        const labels = top.map(p => p.alias || p.public_key.slice(0, 6));
                        const data = top.map(p => p.total_rx + p.total_tx);
                        if (otherTotal > 0) { labels.push('其他'); data.push(otherTotal); }

                        pieChart = new Chart(pieEl.getContext('2d'), {
                            type: 'doughnut',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: data,
                                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#6366f1', '#ec4899', '#94a3b8'],
                                    borderColor: isDark.value ? '#1e293b' : '#fff', borderWidth: 2, hoverOffset: 10
                                }]
                            },
                            options: {
                                animation: { animateScale: true, animateRotate: true },
                                responsive: true, maintainAspectRatio: false, cutout: '70%',
                                plugins: {
                                    legend: { position: 'right', labels: { usePointStyle: true, pointStyle: 'circle', color: textColor, padding: 15, font: { size: 11 } } },
                                    tooltip: { callbacks: { label: (c) => ` ${c.label}: ${fmtBytes(c.raw)}` } }
                                }
                            }
                        });
                    }

                    if (barEl && analysisData.value.hourly_profile) {
                        const ctx = barEl.getContext('2d');
                        const gradientBar = ctx.createLinearGradient(0, 0, 0, 300);
                        gradientBar.addColorStop(0, '#3b82f6'); gradientBar.addColorStop(1, '#60a5fa');

                        barChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: analysisData.value.hourly_profile.map(h => h.hour + ':00'),
                                datasets: [{
                                    label: '流量', data: analysisData.value.hourly_profile.map(h => h.rx_sum + h.tx_sum),
                                    backgroundColor: gradientBar, borderRadius: 6, borderSkipped: false, barPercentage: 0.6
                                }]
                            },
                            options: {
                                animation: { duration: 1000 },
                                responsive: true, maintainAspectRatio: false,
                                scales: {
                                    x: { grid: { display: false }, ticks: { color: textColor, maxTicksLimit: 8, font: { size: 10 } }, border: { display: false } },
                                    y: { display: false }
                                },
                                plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => ` 总流量: ${fmtBytes(c.raw)}` }, displayColors: false } }
                            }
                        });
                    }
                };

                const refreshIcons = () => {
                    if (iconsTimer) clearTimeout(iconsTimer);
                    iconsTimer = setTimeout(() => lucide.createIcons(), 100);
                };

                const showToast = (message, type = 'success') => {
                    const id = Date.now();
                    toasts.value.push({ id, message, type });
                    setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000);
                };

                const copyText = (text, label) => {
                    if (!text) return;
                    navigator.clipboard.writeText(text).then(() => showToast(`${label} 已复制`));
                };

                const editing = ref(null);
                const tempAlias = ref('');
                const editAlias = (p) => { editing.value = p.public_key; tempAlias.value = p.alias || ''; };
                const saveAlias = async (pk) => {
                    if (editing.value !== pk) return;
                    try {
                        await axios.post('/api/alias', { public_key: pk, alias: tempAlias.value }, { headers: { Authorization: `Bearer ${token.value}` } });
                        showToast('别名已更新');
                        // SSE会自动更新列表，无需手动fetch
                    } catch { showToast('保存失败', 'error'); }
                    editing.value = null;
                };

                // --- 管理功能逻辑 ---
                const openAddModal = async () => {
                    try {
                        const res = await axios.get('/api/manage/configs', { headers: { Authorization: `Bearer ${token.value}` } });
                        availableConfigs.value = res.data.configs;
                        if (availableConfigs.value.length > 0) newPeer.config = availableConfigs.value[0];
                        newPeer.name = '';
                        newPeer.ip = '';
                        showAddModal.value = true;
                        suggestIP();
                    } catch (e) { showToast('无法加载接口列表', 'error'); }
                };

                const suggestIP = async () => {
                    if (!newPeer.config) return;
                    ipLoading.value = true;
                    try {
                        const res = await axios.get(`/api/manage/suggest_ip?config=${newPeer.config}`, {
                            headers: { Authorization: `Bearer ${token.value}` }
                        });
                        if (res.data.ip) {
                            newPeer.ip = res.data.ip;
                        }
                    } catch (e) {
                        showToast('无法获取可用IP', 'error');
                    } finally {
                        ipLoading.value = false;
                    }
                };

                // --- 二维码更新逻辑 ---
                watch(generatedConfigStr, () => {
                    if (showConfigModal.value) {
                        isQrUpdating.value = true;
                        debouncedRenderQR();
                    }
                });

                const renderQR = (text) => {
                    const el = document.getElementById('qrcode');
                    if (!el) return;
                    el.innerHTML = '';
                    if (!text.trim()) return;
                    try {
                        new QRCode(el, {
                            text: text,
                            width: 180,
                            height: 180,
                            correctLevel: QRCode.CorrectLevel.M
                        });
                    } catch (e) { console.error(e); }
                    finally {
                        isQrUpdating.value = false;
                    }
                };

                const debouncedRenderQR = debounce(() => {
                    renderQR(generatedConfigStr.value);
                }, 500);

                const createPeer = async () => {
                    try {
                        const res = await axios.post('/api/manage/peer', {
                            config_file: newPeer.config,
                            name: newPeer.name,
                            allowed_ips: newPeer.ip
                        }, { headers: { Authorization: `Bearer ${token.value}` } });

                        if (res.data.status === 'ok') {
                            showAddModal.value = false;
                            showToast('客户端创建成功');
                            
                            const conf = `[Interface]
PrivateKey = ${res.data.private_key}
Address = ${newPeer.ip.split('/')[0]}/32
DNS = 1.1.1.1

[Peer]
PublicKey = ${res.data.server_public_key}
PresharedKey = ${res.data.preshared_key}
Endpoint = ${window.location.hostname}:${res.data.server_port}
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
`;
                            generatedConfigStr.value = conf;
                            showConfigModal.value = true;
                            await nextTick();
                            renderQR(conf);
                        } else {
                            showToast(res.data.error || '创建失败', 'error');
                        }
                    } catch (e) { showToast('请求失败', 'error'); }
                };

                const deletePeer = (p) => {
                    peerToDelete.value = p;
                    showDeleteModal.value = true;
                };

                const confirmDelete = async () => {
                    if (!peerToDelete.value) return;
                    deleteLoading.value = true;
                    try {
                        const configName = availableConfigs.value[0] || 'wg0';

                        await axios.delete(`/api/manage/peer?config=${configName}&public_key=${encodeURIComponent(peerToDelete.value.public_key)}`,
                            { headers: { Authorization: `Bearer ${token.value}` } }
                        );

                        showToast('客户端已删除');
                        showDeleteModal.value = false;
                        // SSE会自动更新，无需fetch
                    } catch (e) {
                        showToast('删除失败: ' + (e.response?.data?.error || '未知错误'), 'error');
                    } finally {
                        deleteLoading.value = false;
                        peerToDelete.value = null;
                    }
                };

                const downloadConfig = () => {
                    const blob = new Blob([generatedConfigStr.value], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `wg-${newPeer.name}.conf`;
                    a.click();
                };

                const changeMainChartPeriod = () => { 
                    if (mainChartInst) { mainChartInst.destroy(); mainChartInst = null; } 
                    fetchMainChart(); 
                };
                const changeHistoryPeriod = () => { fetchDetailData(); };
                const formatLastSeen = (ts) => ts ? new Date(ts * 1000).toLocaleString() : '从不';
                const getHealthClass = (s) => {
                    if (s >= 90) return 'bg-emerald-50 dark:bg-emerald-500/10 border-emerald-200 dark:border-emerald-500/20 text-emerald-600 dark:text-emerald-400';
                    if (s >= 60) return 'bg-yellow-50 dark:bg-yellow-500/10 border-yellow-200 dark:border-yellow-500/20 text-yellow-600 dark:text-yellow-400';
                    return 'bg-red-50 dark:bg-red-500/10 border-red-200 dark:border-red-500/20 text-red-600 dark:text-red-400';
                };
                const totalRxRate = computed(() => peers.value.reduce((a, b) => a + (b.rx_rate || 0), 0));
                const totalTxRate = computed(() => peers.value.reduce((a, b) => a + (b.tx_rate || 0), 0));
                const onlineCount = computed(() => peers.value.filter(p => p.is_online).length);
                const getTrafficRatio = (p) => {
                    const t = (p.receive_bytes || 0) + (p.transmit_bytes || 0);
                    return t === 0 ? { tx: 0, rx: 0 } : { tx: (p.transmit_bytes / t) * 100, rx: (p.receive_bytes / t) * 100 };
                };
                const fmtBytes = (b) => {
                    if (!b) return '0 B';
                    const i = Math.floor(Math.log(b) / Math.log(1024));
                    return (b / Math.pow(1024, i)).toFixed(1) + ' ' + ['B', 'KB', 'MB', 'GB', 'TB'][i];
                };
                const fmtRate = (v) => v ? v.toFixed(2) + ' Mbps' : '0 Mbps';
                const sort = (key) => {
                    if (sortKey.value === key) sortDesc.value = !sortDesc.value;
                    else { sortKey.value = key; sortDesc.value = true; }
                };

                onMounted(() => {
                    initTheme();
                    if (token.value) initDashboard();
                    refreshIcons();
                });

                onUnmounted(() => {
                    if (es.value) es.value.close();
                    [mainChartInst, detailChartInst, pieChart, barChart].forEach(c => c?.destroy());
                });

                return {
                    token, loginPassword, loginError, isLoggingIn, handleLogin, logout,
                    peers, meta, sysInfo, sortedPeers, totalRxRate, totalTxRate, onlineCount,
                    searchQuery, statusFilter, mainChartPeriod, changeMainChartPeriod,
                    modalPeer, historyPeriod, changeHistoryPeriod, openDetail, chartLoading,
                    showAnalysis, analysisLoading, openAnalysis, analysisData,
                    editing, tempAlias, editAlias, saveAlias,
                    toasts, autoRefresh, toggleAutoRefresh, isConnected,
                    sort, copyText, fmtRate, fmtBytes, getTrafficRatio, formatLastSeen, getHealthClass,
                    isDark, toggleTheme,
                    showAddModal, showConfigModal, availableConfigs, newPeer, generatedConfigStr, ipLoading, isQrUpdating,
                    openAddModal, createPeer, deletePeer, downloadConfig, suggestIP,
                    showDeleteModal, peerToDelete, deleteLoading, confirmDelete,
                    accessLogs, logsLoading, fetchAccessLogs, getCountryCode
                };
            }
        }).mount('#app');
    </script>
</body>

</html>
